<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Warehouse Warriors - Real Logistics Co-op</title>
    <!-- Include Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
            max-width: 1400px;
            padding: 25px;
            background: rgba(0, 30, 60, 0.8);
            border-radius: 15px;
            border: 2px solid #2a9d8f;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #2a9d8f, #e9c46a);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(42, 157, 143, 0.3);
        }
        
        .tagline {
            font-size: 1.4rem;
            opacity: 0.9;
            margin-bottom: 15px;
            color: #e9c46a;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #a8dadc;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            width: 100%;
            max-width: 1600px;
        }
        
        .game-section {
            flex: 1;
            min-width: 350px;
            height: 700px;
            background: rgba(10, 25, 47, 0.9);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            border: 2px solid #264653;
            position: relative;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #0a192f;
        }
        
        .control-panel {
            flex: 0 0 450px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .panel {
            background: rgba(23, 42, 69, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid #2a9d8f;
            backdrop-filter: blur(10px);
        }
        
        .panel h2 {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: #2a9d8f;
            border-bottom: 2px solid #264653;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .room-section {
            text-align: center;
        }
        
        .room-code-container {
            margin: 25px 0;
            padding: 25px;
            background: rgba(10, 25, 47, 0.8);
            border-radius: 10px;
            border: 2px solid #e9c46a;
        }
        
        .room-code {
            font-size: 4.5rem;
            font-weight: bold;
            letter-spacing: 15px;
            color: #e9c46a;
            text-shadow: 0 0 25px rgba(233, 196, 106, 0.5);
            margin: 20px 0;
            font-family: monospace;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 3px solid #f4a261;
        }
        
        .code-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            background: linear-gradient(90deg, #264653, #2a9d8f);
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 5px 20px rgba(42, 157, 143, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(42, 157, 143, 0.6);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-copy {
            background: linear-gradient(90deg, #e9c46a, #f4a261);
            box-shadow: 0 5px 20px rgba(233, 196, 106, 0.4);
        }
        
        .btn-start {
            background: linear-gradient(90deg, #e76f51, #f4a261);
            box-shadow: 0 5px 20px rgba(231, 111, 81, 0.4);
            grid-column: span 2;
        }
        
        .btn-role {
            background: linear-gradient(90deg, #1d3557, #457b9d);
            box-shadow: 0 5px 20px rgba(29, 53, 87, 0.4);
        }
        
        .btn-disabled {
            background: #495057;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        
        .btn-disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px;
            background: rgba(10, 25, 47, 0.7);
            border-radius: 10px;
            border: 2px solid;
            transition: all 0.3s ease;
        }
        
        .player-item.ready {
            border-color: #2a9d8f;
            background: rgba(42, 157, 143, 0.15);
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .player-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #264653, #2a9d8f);
        }
        
        .player-details {
            flex: 1;
        }
        
        .player-name {
            font-weight: 600;
            font-size: 1.3rem;
            margin-bottom: 5px;
        }
        
        .player-role {
            font-size: 0.95rem;
            color: #a8dadc;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .player-stats {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .player-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.9rem;
            border: 1px solid rgba(168, 218, 220, 0.2);
        }
        
        .status-message {
            text-align: center;
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid;
            font-size: 1.1rem;
        }
        
        .status-connecting {
            background: rgba(233, 196, 106, 0.1);
            color: #e9c46a;
            border-color: rgba(233, 196, 106, 0.3);
        }
        
        .status-connected {
            background: rgba(42, 157, 143, 0.1);
            color: #2a9d8f;
            border-color: rgba(42, 157, 143, 0.3);
        }
        
        .status-working {
            background: rgba(69, 123, 157, 0.1);
            color: #457b9d;
            border-color: rgba(69, 123, 157, 0.3);
        }
        
        .status-error {
            background: rgba(231, 111, 81, 0.1);
            color: #e76f51;
            border-color: rgba(231, 111, 81, 0.3);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .control-key {
            background: rgba(10, 25, 47, 0.7);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(42, 157, 143, 0.2);
            transition: all 0.3s ease;
        }
        
        .control-key:hover {
            transform: translateY(-3px);
            border-color: #2a9d8f;
            box-shadow: 0 5px 15px rgba(42, 157, 143, 0.3);
        }
        
        .key {
            display: inline-block;
            background: rgba(23, 42, 69, 0.9);
            padding: 10px 18px;
            border-radius: 8px;
            font-family: monospace;
            font-weight: bold;
            margin-right: 10px;
            border: 2px solid #2a9d8f;
            color: #a8dadc;
            font-size: 1.1rem;
        }
        
        .game-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
            padding: 20px;
            background: rgba(10, 25, 47, 0.7);
            border-radius: 10px;
            border: 1px solid rgba(42, 157, 143, 0.2);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #e9c46a;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 0.95rem;
            color: #a8dadc;
        }
        
        .orders-panel {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .order-item {
            background: rgba(10, 25, 47, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(233, 196, 106, 0.2);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #e9c46a;
            font-weight: 600;
        }
        
        .order-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .order-tag {
            background: rgba(42, 157, 143, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            border: 1px solid #2a9d8f;
        }
        
        .game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 30px;
            z-index: 100;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
        }
        
        .game-overlay h2 {
            font-size: 3.5rem;
            color: #e9c46a;
            text-shadow: 0 0 30px rgba(233, 196, 106, 0.5);
        }
        
        .game-overlay p {
            font-size: 1.5rem;
            color: #a8dadc;
            max-width: 80%;
            line-height: 1.6;
        }
        
        .hidden {
            display: none !important;
        }
        
        .role-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .role-card {
            background: rgba(10, 25, 47, 0.7);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .role-card.selected {
            border-color: #e9c46a;
            background: rgba(233, 196, 106, 0.1);
        }
        
        .role-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .role-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2a9d8f;
        }
        
        .role-desc {
            font-size: 0.95rem;
            color: #a8dadc;
            line-height: 1.5;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(10, 25, 47, 0.7);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2a9d8f, #a8dadc);
            transition: width 0.3s ease;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            opacity: 0.8;
            font-size: 0.95rem;
            max-width: 1400px;
            padding: 20px;
            color: #a8dadc;
        }
        
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            
            .control-panel {
                width: 100%;
                max-width: 800px;
            }
            
            .game-section {
                height: 500px;
            }
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .room-code {
                font-size: 3rem;
                letter-spacing: 10px;
                padding: 15px;
            }
            
            .game-section {
                height: 400px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .role-selection {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì¶ Warehouse Warriors</h1>
        <p class="tagline">Real Logistics Co-op Simulation</p>
        <p class="subtitle">Work together as a warehouse team - pick, pack, and ship orders efficiently. Based on real Amazon Fulfillment Center operations!</p>
    </div>
    
    <div class="container">
        <div class="game-section">
            <canvas id="gameCanvas"></canvas>
            <div id="waitingOverlay" class="game-overlay">
                <h2>üè≠ Warehouse Warriors</h2>
                <p>Create a room or join with a 4-digit code to start working!</p>
                <p style="font-size: 1.2rem; color: #e9c46a;">Choose your role: Picker, Packer, or Manager</p>
                <p style="font-size: 1rem; color: #a8dadc;">Real warehouse simulation with shift goals and team coordination</p>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="panel room-section">
                <h2>üè¢ Warehouse Setup</h2>
                <div id="statusMessage" class="status-message status-connecting">
                    üîç Looking for available warehouse teams...
                </div>
                
                <div id="hostSection" class="hidden">
                    <div class="room-code-container">
                        <h3>Team Code</h3>
                        <div class="room-code" id="roomCode">0000</div>
                        <div class="code-actions">
                            <button id="copyBtn" class="btn btn-copy">üìã Copy Code</button>
                            <button id="newCodeBtn" class="btn">üîÑ New Code</button>
                        </div>
                        <p style="margin-top: 15px; color: #a8dadc; font-size: 0.95rem;">
                            Share this code with your warehouse team members
                        </p>
                    </div>
                </div>
                
                <div id="joinSection">
                    <h3>Join Warehouse Team</h3>
                    <input type="text" id="roomInput" class="room-input" maxlength="4" placeholder="Enter 4-digit team code" pattern="[0-9]{4}" style="width: 100%; padding: 15px; font-size: 1.2rem; text-align: center; background: rgba(10,25,47,0.8); border: 2px solid #2a9d8f; border-radius: 10px; color: white; margin-bottom: 20px;">
                    <div class="code-actions">
                        <button id="joinBtn" class="btn">üë• Join Team</button>
                        <button id="createBtn" class="btn">üè¢ Create Team</button>
                    </div>
                </div>
                
                <div id="roleSelection" class="hidden">
                    <h3>üëî Choose Your Role</h3>
                    <div class="role-selection">
                        <div class="role-card" onclick="selectRole('picker')">
                            <div class="role-icon">üì¶</div>
                            <div class="role-title">Picker</div>
                            <div class="role-desc">Collect items from shelves. Move with WASD, pick with SPACE. Accuracy matters!</div>
                        </div>
                        <div class="role-card" onclick="selectRole('packer')">
                            <div class="role-icon">üì¶</div>
                            <div class="role-title">Packer</div>
                            <div class="role-desc">Pack items into boxes. Quality control and speed needed!</div>
                        </div>
                        <div class="role-card" onclick="selectRole('manager')">
                            <div class="role-icon">üìä</div>
                            <div class="role-title">Manager</div>
                            <div class="role-desc">Monitor operations, assign tasks, optimize workflow.</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2>üë• Warehouse Team</h2>
                <div class="player-list" id="playerList">
                    <!-- Players will be added here -->
                </div>
                <button id="readyBtn" class="btn btn-start btn-disabled">‚è≥ Waiting for team members...</button>
            </div>
            
            <div class="panel">
                <h2>üìä Shift Stats</h2>
                <div class="game-stats">
                    <div class="stat">
                        <div class="stat-value" id="ordersCompleted">0</div>
                        <div class="stat-label">Orders Completed</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="itemsPicked">0</div>
                        <div class="stat-label">Items Picked</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="timeLeft">08:00</div>
                        <div class="stat-label">Shift Time</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="shiftProgress" style="width: 0%"></div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <div style="font-size: 1.1rem; color: #e9c46a;">Shift Goal: <span id="shiftGoal">50</span> orders</div>
                    <div style="font-size: 0.9rem; color: #a8dadc; margin-top: 5px;">Efficiency Bonus: <span id="efficiencyBonus">0%</span></div>
                </div>
            </div>
            
            <div class="panel orders-panel">
                <h2>üìã Active Orders</h2>
                <div id="ordersList">
                    <!-- Orders will be added here -->
                </div>
            </div>
            
            <div class="panel">
                <h2>üéÆ Controls</h2>
                <div class="controls-grid">
                    <div class="control-key">
                        <span class="key">W</span> / <span class="key">S</span><br>
                        Move Forward/Back
                    </div>
                    <div class="control-key">
                        <span class="key">A</span> / <span class="key">D</span><br>
                        Move Left/Right
                    </div>
                    <div class="control-key">
                        <span class="key">SPACE</span><br>
                        Pick/Pack Item
                    </div>
                    <div class="control-key">
                        <span class="key">E</span><br>
                        Interact
                    </div>
                    <div class="control-key">
                        <span class="key">Q</span><br>
                        Drop Item
                    </div>
                    <div class="control-key">
                        <span class="key">TAB</span><br>
                        View Tasks
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Warehouse Warriors - Realistic logistics co-op simulation based on actual warehouse operations</p>
        <p>Work together as a team to meet shift goals, optimize workflow, and earn bonuses!</p>
    </div>

    <script>
        // ==================== REAL WAREHOUSE SIMULATION ====================
        // Based on Amazon Fulfillment Center operations
        
        // Game state
        const gameState = {
            roomCode: null,
            players: {},
            playerId: null,
            isHost: false,
            shiftStarted: false,
            shiftTime: 8 * 60, // 8 hours in minutes (simulated as 8 minutes)
            shiftGoal: 50,
            ordersCompleted: 0,
            itemsPicked: 0,
            itemsPacked: 0,
            efficiency: 100,
            currentOrders: [],
            completedOrders: [],
            warehouse: {
                shelves: [],
                packingStations: [],
                shippingZone: null,
                breakRoom: null
            },
            playerRole: null,
            score: 0,
            bonuses: {
                onTime: 0,
                accuracy: 0,
                teamwork: 0
            }
        };
        
        // Three.js variables
        let scene, camera, renderer, canvas;
        let playerMesh, shelfMeshes = [], itemMeshes = [], boxMeshes = [];
        let keys = {};
        let heldItem = null;
        
        // Warehouse items database (real products)
        const warehouseItems = [
            { id: 1, name: "Smartphone", size: "small", weight: 0.2, color: 0x333333 },
            { id: 2, name: "Laptop", size: "medium", weight: 2.0, color: 0x666666 },
            { id: 3, name: "Headphones", size: "small", weight: 0.3, color: 0x0000ff },
            { id: 4, name: "Book", size: "small", weight: 0.5, color: 0x8b4513 },
            { id: 5, name: "T-shirt", size: "medium", weight: 0.2, color: 0xff0000 },
            { id: 6, name: "Shoes", size: "medium", weight: 1.0, color: 0x008000 },
            { id: 7, name: "Monitor", size: "large", weight: 5.0, color: 0x000000 },
            { id: 8, name: "Keyboard", size: "medium", weight: 1.0, color: 0x808080 },
            { id: 9, name: "Mouse", size: "small", weight: 0.1, color: 0x800080 },
            { id: 10, name: "Water Bottle", size: "small", weight: 0.5, color: 0x00ffff }
        ];
        
        // ==================== NETWORKING SYSTEM ====================
        class WarehouseNetwork {
            constructor() {
                this.localId = 'worker_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.currentRoom = null;
                this.isHost = false;
                this.connectionInterval = null;
                
                // Setup communication
                this.setupCommunication();
            }
            
            setupCommunication() {
                // Use BroadcastChannel if available, localStorage fallback
                try {
                    this.broadcastChannel = new BroadcastChannel('warehouse_warriors');
                    this.broadcastChannel.onmessage = (event) => this.handleMessage(event.data);
                } catch (e) {
                    console.log("Using localStorage for communication");
                    this.broadcastChannel = null;
                }
            }
            
            sendMessage(data) {
                data.roomCode = this.currentRoom;
                data.timestamp = Date.now();
                data.senderId = this.localId;
                
                if (this.broadcastChannel) {
                    this.broadcastChannel.postMessage(data);
                } else {
                    // localStorage fallback
                    localStorage.setItem('warehouse_msg', JSON.stringify(data));
                    setTimeout(() => localStorage.removeItem('warehouse_msg'), 100);
                }
            }
            
            handleMessage(data) {
                if (data.roomCode !== this.currentRoom) return;
                if (data.senderId === this.localId) return;
                
                switch(data.type) {
                    case 'roomCreated':
                        this.handleRoomCreated(data);
                        break;
                    case 'joinRequest':
                        if (this.isHost) this.handleJoinRequest(data);
                        break;
                    case 'joinAccepted':
                        if (!this.isHost) this.handleJoinAccepted(data);
                        break;
                    case 'gameState':
                        this.handleGameState(data.state);
                        break;
                    case 'playerAction':
                        this.handlePlayerAction(data);
                        break;
                    case 'playerReady':
                        this.handlePlayerReady(data);
                        break;
                    case 'orderUpdate':
                        this.handleOrderUpdate(data);
                        break;
                }
            }
            
            createRoom() {
                const roomCode = this.generateRoomCode();
                this.currentRoom = roomCode;
                this.isHost = true;
                gameState.roomCode = roomCode;
                gameState.playerId = this.localId;
                gameState.isHost = true;
                
                // Initialize warehouse
                gameState.players = {};
                gameState.players[this.localId] = {
                    id: this.localId,
                    name: 'Shift Manager',
                    role: 'manager',
                    color: '#e76f51',
                    ready: false,
                    position: { x: 0, y: 1, z: 0 },
                    stats: { itemsPicked: 0, itemsPacked: 0, ordersCompleted: 0 }
                };
                
                this.sendMessage({
                    type: 'roomCreated',
                    roomCode: roomCode,
                    hostId: this.localId
                });
                
                this.updatePlayerList();
                this.syncGameState();
                return roomCode;
            }
            
            joinRoom(roomCode) {
                if (!this.validateRoomCode(roomCode)) {
                    showError('Invalid team code! Must be 4 digits.');
                    return false;
                }
                
                this.currentRoom = roomCode;
                this.isHost = false;
                gameState.roomCode = roomCode;
                gameState.playerId = this.localId;
                gameState.isHost = false;
                
                gameState.players[this.localId] = {
                    id: this.localId,
                    name: 'New Worker',
                    role: null,
                    color: this.getRandomColor(),
                    ready: false,
                    position: { x: 5, y: 1, z: 5 },
                    stats: { itemsPicked: 0, itemsPacked: 0, ordersCompleted: 0 }
                };
                
                this.sendMessage({
                    type: 'joinRequest',
                    roomCode: roomCode,
                    playerId: this.localId,
                    playerInfo: gameState.players[this.localId]
                });
                
                this.updatePlayerList();
                return true;
            }
            
            handleRoomCreated(data) {
                showMessage(`Team ${data.roomCode} found! Choose your role.`);
            }
            
            handleJoinRequest(data) {
                if (!this.isHost) return;
                
                gameState.players[data.playerId] = data.playerInfo;
                this.sendMessage({
                    type: 'joinAccepted',
                    roomCode: this.currentRoom,
                    gameState: gameState
                });
                
                this.updatePlayerList();
                this.syncGameState();
                showMessage(`${data.playerInfo.name} joined the team!`);
            }
            
            handleJoinAccepted(data) {
                Object.assign(gameState, data.gameState);
                updateGameUI();
                showMessage(`Joined team ${data.roomCode}! Choose your role.`);
            }
            
            handleGameState(state) {
                // Merge received state (preserve local player data)
                const localPlayer = gameState.players[gameState.playerId];
                Object.assign(gameState, state);
                if (localPlayer) {
                    gameState.players[gameState.playerId] = localPlayer;
                }
                updateGameUI();
                updateWarehouseObjects();
            }
            
            handlePlayerAction(data) {
                // Handle other players' actions
                // This could be used for real-time position updates
            }
            
            handlePlayerReady(data) {
                if (gameState.players[data.playerId]) {
                    gameState.players[data.playerId].ready = true;
                    this.updatePlayerList();
                    
                    // Check if all players are ready
                    const players = Object.values(gameState.players);
                    const allReady = players.length >= 1 && players.every(p => p.ready);
                    if (allReady && this.isHost) {
                        startShift();
                    }
                }
            }
            
            handleOrderUpdate(data) {
                if (data.orderId) {
                    const orderIndex = gameState.currentOrders.findIndex(o => o.id === data.orderId);
                    if (orderIndex !== -1) {
                        gameState.currentOrders[orderIndex] = data.orderData;
                        updateOrdersDisplay();
                    }
                }
            }
            
            syncGameState() {
                this.sendMessage({
                    type: 'gameState',
                    state: gameState
                });
            }
            
            sendPlayerReady() {
                if (gameState.players[this.localId]) {
                    gameState.players[this.localId].ready = true;
                    this.sendMessage({
                        type: 'playerReady',
                        playerId: this.localId
                    });
                    this.updatePlayerList();
                }
            }
            
            sendOrderUpdate(orderId, orderData) {
                this.sendMessage({
                    type: 'orderUpdate',
                    orderId: orderId,
                    orderData: orderData
                });
            }
            
            generateRoomCode() {
                return Math.floor(1000 + Math.random() * 9000).toString();
            }
            
            validateRoomCode(code) {
                return /^\d{4}$/.test(code);
            }
            
            getRandomColor() {
                const colors = ['#2a9d8f', '#e9c46a', '#f4a261', '#e76f51', '#457b9d'];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            updatePlayerList() {
                const playerList = document.getElementById('playerList');
                playerList.innerHTML = '';
                
                Object.values(gameState.players).forEach(player => {
                    const playerItem = document.createElement('div');
                    playerItem.className = `player-item ${player.ready ? 'ready' : ''}`;
                    playerItem.style.borderColor = player.color;
                    
                    const roleIcon = player.role === 'picker' ? 'üì¶' : 
                                   player.role === 'packer' ? 'üì¶' : 
                                   player.role === 'manager' ? 'üìä' : 'üë§';
                    
                    playerItem.innerHTML = `
                        <div class="player-info">
                            <div class="player-avatar" style="background: ${player.color}">
                                ${roleIcon}
                            </div>
                            <div class="player-details">
                                <div class="player-name">${player.name}</div>
                                <div class="player-role">
                                    ${player.role ? 
                                        (player.role === 'picker' ? 'üì¶ Picker' : 
                                         player.role === 'packer' ? 'üì¶ Packer' : 
                                         'üìä Manager') : 
                                        'üë§ Choosing role...'}
                                </div>
                                <div class="player-stats">
                                    <span class="player-stat">üì¶ ${player.stats.itemsPicked}</span>
                                    <span class="player-stat">üì¶ ${player.stats.itemsPacked}</span>
                                    <span class="player-stat">‚úÖ ${player.stats.ordersCompleted}</span>
                                </div>
                            </div>
                        </div>
                        <div class="${player.ready ? 'player-ready' : 'player-waiting'}">
                            ${player.ready ? '‚úÖ Ready' : '‚è≥ Waiting'}
                        </div>
                    `;
                    
                    playerList.appendChild(playerItem);
                });
                
                // Update ready button
                const readyBtn = document.getElementById('readyBtn');
                if (gameState.players[gameState.playerId]?.role) {
                    readyBtn.disabled = false;
                    readyBtn.className = 'btn btn-start';
                    readyBtn.innerHTML = gameState.players[gameState.playerId]?.ready ? '‚úÖ Ready for Shift!' : 'üë∑ Start Shift';
                } else {
                    readyBtn.disabled = true;
                    readyBtn.className = 'btn btn-start btn-disabled';
                    readyBtn.innerHTML = '‚è≥ Choose your role first';
                }
            }
        }
        
        const network = new WarehouseNetwork();
        
        // ==================== WAREHOUSE INITIALIZATION ====================
        function initGame() {
            // Create Three.js scene
            canvas = document.getElementById('gameCanvas');
            
            if (typeof THREE === 'undefined') {
                showError('Three.js failed to load. Please refresh the page.');
                return;
            }
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a192f);
            scene.fog = new THREE.Fog(0x0a192f, 50, 200);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(0, 25, 30);
            camera.lookAt(0, 0, 0);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Setup warehouse
            setupWarehouse();
            
            // Start game loop
            gameLoop();
            
            // Setup event listeners
            setupEventListeners();
            
            showMessage('Welcome to Warehouse Warriors! Create or join a warehouse team.');
        }
        
        function setupWarehouse() {
            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.left = -100;
            directionalLight.shadow.camera.right = 100;
            directionalLight.shadow.camera.top = 100;
            directionalLight.shadow.camera.bottom = -100;
            scene.add(directionalLight);
            
            // Warehouse floor
            const floorGeometry = new THREE.PlaneGeometry(200, 200);
            const floorMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x1d3557,
                side: THREE.DoubleSide
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = Math.PI / 2;
            floor.position.y = -0.5;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Grid for reference
            const gridHelper = new THREE.GridHelper(200, 50, 0x264653, 0x264653);
            gridHelper.position.y = 0.01;
            scene.add(gridHelper);
            
            // Warehouse shelves (4 aisles)
            for (let i = 0; i < 4; i++) {
                createAisle(i * 30 - 45);
            }
            
            // Packing stations
            createPackingStations();
            
            // Shipping zone
            createShippingZone();
            
            // Break room
            createBreakRoom();
            
            // Player mesh
            const playerGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 8);
            const playerMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x2a9d8f,
                emissive: 0x264653,
                emissiveIntensity: 0.2
            });
            playerMesh = new THREE.Mesh(playerGeometry, playerMaterial);
            playerMesh.position.y = 1;
            playerMesh.castShadow = true;
            scene.add(playerMesh);
            
            // Add initial items to shelves
            populateShelves();
            
            // Generate initial orders
            generateOrders(5);
        }
        
        function createAisle(xPosition) {
            // Create shelf units for an aisle
            for (let i = 0; i < 5; i++) {
                const shelfGeometry = new THREE.BoxGeometry(8, 6, 2);
                const shelfMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x457b9d,
                    transparent: true,
                    opacity: 0.8
                });
                const shelf = new THREE.Mesh(shelfGeometry, shelfMaterial);
                shelf.position.set(xPosition, 3, i * 15 - 30);
                shelf.castShadow = true;
                shelf.receiveShadow = true;
                
                shelfMeshes.push({
                    mesh: shelf,
                    aisle: Math.floor(xPosition / 30) + 1,
                    section: i + 1,
                    items: []
                });
                
                scene.add(shelf);
            }
        }
        
        function createPackingStations() {
            for (let i = 0; i < 3; i++) {
                const stationGeometry = new THREE.BoxGeometry(4, 1, 4);
                const stationMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xe9c46a
                });
                const station = new THREE.Mesh(stationGeometry, stationMaterial);
                station.position.set(60, 0.5, i * 20 - 20);
                scene.add(station);
                
                gameState.warehouse.packingStations.push({
                    mesh: station,
                    occupied: false,
                    currentOrder: null
                });
            }
        }
        
        function createShippingZone() {
            const zoneGeometry = new THREE.BoxGeometry(20, 0.5, 20);
            const zoneMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xe76f51,
                transparent: true,
                opacity: 0.7
            });
            const zone = new THREE.Mesh(zoneGeometry, zoneMaterial);
            zone.position.set(0, 0.25, 60);
            scene.add(zone);
            
            gameState.warehouse.shippingZone = zone;
        }
        
        function createBreakRoom() {
            const roomGeometry = new THREE.BoxGeometry(15, 5, 15);
            const roomMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xa8dadc,
                transparent: true,
                opacity: 0.9
            });
            const room = new THREE.Mesh(roomGeometry, roomMaterial);
            room.position.set(-60, 2.5, 0);
            scene.add(room);
            
            gameState.warehouse.breakRoom = room;
        }
        
        function populateShelves() {
            shelfMeshes.forEach((shelf, shelfIndex) => {
                // Add 3-5 items per shelf
                const itemCount = 3 + Math.floor(Math.random() * 3);
                for (let i = 0; i < itemCount; i++) {
                    const itemType = warehouseItems[Math.floor(Math.random() * warehouseItems.length)];
                    const itemGeometry = new THREE.BoxGeometry(1, 1, 1);
                    const itemMaterial = new THREE.MeshPhongMaterial({ 
                        color: itemType.color
                    });
                    const item = new THREE.Mesh(itemGeometry, itemMaterial);
                    
                    // Position item on shelf
                    item.position.set(
                        shelf.mesh.position.x + (Math.random() - 0.5) * 6,
                        shelf.mesh.position.y - 1 + Math.random() * 4,
                        shelf.mesh.position.z + (Math.random() - 0.5) * 1.5
                    );
                    
                    item.castShadow = true;
                    scene.add(item);
                    
                    shelf.items.push({
                        mesh: item,
                        type: itemType,
                        picked: false
                    });
                    
                    itemMeshes.push(item);
                }
            });
        }
        
        function generateOrders(count) {
            for (let i = 0; i < count; i++) {
                const orderId = 'ORD' + Date.now() + Math.floor(Math.random() * 1000);
                const itemCount = 2 + Math.floor(Math.random() * 4);
                const items = [];
                
                for (let j = 0; j < itemCount; j++) {
                    const item = warehouseItems[Math.floor(Math.random() * warehouseItems.length)];
                    items.push({
                        ...item,
                        picked: false,
                        packed: false
                    });
                }
                
                const order = {
                    id: orderId,
                    items: items,
                    status: 'pending', // pending, picking, packing, ready, shipped
                    priority: Math.random() > 0.7 ? 'high' : 'normal',
                    createdAt: Date.now(),
                    timeLimit: 5 * 60 * 1000, // 5 minutes in real time
                    assignedTo: null
                };
                
                gameState.currentOrders.push(order);
            }
            updateOrdersDisplay();
        }
        
        // ==================== GAME LOGIC ====================
        function gameLoop() {
            if (gameState.shiftStarted) {
                // Update shift timer
                updateShiftTimer();
                
                // Update player movement
                updatePlayerMovement();
                
                // Check for completed orders
                checkCompletedOrders();
                
                // Generate new orders periodically
                if (Math.floor(gameState.shiftTime) % 30 === 0 && 
                    gameState.currentOrders.length < 10) {
                    generateOrders(2);
                }
                
                // Update UI
                updateGameUI();
                
                // Check shift end
                if (gameState.shiftTime <= 0) {
                    endShift();
                }
                
                // Sync game state every few seconds
                if (Math.floor(gameState.shiftTime) % 10 === 0) {
                    network.syncGameState();
                }
            }
            
            // Camera follows player
            if (playerMesh) {
                camera.position.x = playerMesh.position.x;
                camera.position.z = playerMesh.position.z + 20;
                camera.position.y = 25;
                camera.lookAt(playerMesh.position.x, 0, playerMesh.position.z);
            }
            
            // Render
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function updatePlayerMovement() {
            if (!gameState.players[gameState.playerId]) return;
            
            const player = gameState.players[gameState.playerId];
            const speed = 0.2;
            
            // WASD Movement
            if (keys['w'] || keys['ArrowUp']) player.position.z -= speed;
            if (keys['s'] || keys['ArrowDown']) player.position.z += speed;
            if (keys['a'] || keys['ArrowLeft']) player.position.x -= speed;
            if (keys['d'] || keys['ArrowRight']) player.position.x += speed;
            
            // Keep within warehouse bounds
            player.position.x = Math.max(-95, Math.min(95, player.position.x));
            player.position.z = Math.max(-95, Math.min(95, player.position.z));
            
            // Update player mesh position
            playerMesh.position.set(player.position.x, 1, player.position.z);
            
            // Check for item pickup (if picker)
            if (keys[' '] && gameState.playerRole === 'picker') {
                tryPickItem();
            }
            
            // Check for packing (if packer)
            if (keys['e'] && gameState.playerRole === 'packer') {
                tryPackItem();
            }
            
            // Drop item
            if (keys['q'] && heldItem) {
                dropItem();
            }
        }
        
        function tryPickItem() {
            // Check if player is near a shelf with items
            for (const shelf of shelfMeshes) {
                const distance = Math.sqrt(
                    Math.pow(playerMesh.position.x - shelf.mesh.position.x, 2) +
                    Math.pow(playerMesh.position.z - shelf.mesh.position.z, 2)
                );
                
                if (distance < 5 && !heldItem) {
                    // Find an unpicked item on this shelf
                    const availableItem = shelf.items.find(item => !item.picked);
                    if (availableItem) {
                        pickItem(availableItem, shelf);
                        break;
                    }
                }
            }
        }
        
        function pickItem(item, shelf) {
            heldItem = item;
            item.picked = true;
            
            // Remove from shelf visually
            item.mesh.position.y = -10; // Move below floor
            
            // Update player stats
            if (gameState.players[gameState.playerId]) {
                gameState.players[gameState.playerId].stats.itemsPicked++;
                gameState.itemsPicked++;
            }
            
            // Find order that needs this item
            for (const order of gameState.currentOrders) {
                if (order.status === 'pending' || order.status === 'picking') {
                    const orderItem = order.items.find(i => 
                        i.id === item.type.id && !i.picked
                    );
                    if (orderItem) {
                        orderItem.picked = true;
                        order.status = 'picking';
                        
                        // Check if all items are picked
                        if (order.items.every(i => i.picked)) {
                            order.status = 'ready_for_packing';
                        }
                        
                        updateOrdersDisplay();
                        network.sendOrderUpdate(order.id, order);
                        break;
                    }
                }
            }
            
            showMessage(`Picked: ${item.type.name}`);
        }
        
        function tryPackItem() {
            if (!heldItem) return;
            
            // Check if player is at a packing station
            for (const station of gameState.warehouse.packingStations) {
                const distance = Math.sqrt(
                    Math.pow(playerMesh.position.x - station.mesh.position.x, 2) +
                    Math.pow(playerMesh.position.z - station.mesh.position.z, 2)
                );
                
                if (distance < 3) {
                    // Find order ready for packing
                    const order = gameState.currentOrders.find(o => 
                        o.status === 'ready_for_packing'
                    );
                    
                    if (order) {
                        packItem(order);
                        break;
                    }
                }
            }
        }
        
        function packItem(order) {
            // Find if held item belongs to this order
            const orderItem = order.items.find(i => 
                i.id === heldItem.type.id && i.picked && !i.packed
            );
            
            if (orderItem) {
                orderItem.packed = true;
                
                // Update player stats
                if (gameState.players[gameState.playerId]) {
                    gameState.players[gameState.playerId].stats.itemsPacked++;
                    gameState.itemsPacked++;
                }
                
                // Remove held item
                heldItem = null;
                
                // Check if all items are packed
                if (order.items.every(i => i.packed)) {
                    order.status = 'ready_to_ship';
                    showMessage(`Order ${order.id} ready to ship!`);
                }
                
                updateOrdersDisplay();
                network.sendOrderUpdate(order.id, order);
            }
        }
        
        function dropItem() {
            if (heldItem) {
                // Place item near player
                heldItem.mesh.position.set(
                    playerMesh.position.x,
                    1,
                    playerMesh.position.z
                );
                heldItem.picked = false;
                heldItem = null;
                showMessage('Item dropped');
            }
        }
        
        function checkCompletedOrders() {
            // Check for orders ready to ship at shipping zone
            const distanceToShipping = Math.sqrt(
                Math.pow(playerMesh.position.x - gameState.warehouse.shippingZone.position.x, 2) +
                Math.pow(playerMesh.position.z - gameState.warehouse.shippingZone.position.z, 2)
            );
            
            if (distanceToShipping < 10) {
                const readyOrders = gameState.currentOrders.filter(o => 
                    o.status === 'ready_to_ship'
                );
                
                readyOrders.forEach(order => {
                    shipOrder(order);
                });
            }
        }
        
        function shipOrder(order) {
            order.status = 'shipped';
            gameState.ordersCompleted++;
            
            // Update player stats
            if (gameState.players[gameState.playerId]) {
                gameState.players[gameState.playerId].stats.ordersCompleted++;
            }
            
            // Calculate efficiency bonus
            const orderTime = Date.now() - order.createdAt;
            if (orderTime < order.timeLimit) {
                gameState.bonuses.onTime += 10;
            }
            
            // Move to completed orders
            gameState.completedOrders.push(order);
            gameState.currentOrders = gameState.currentOrders.filter(o => o.id !== order.id);
            
            // Add to score
            gameState.score += 100 + gameState.bonuses.onTime;
            
            showMessage(`Order ${order.id} shipped! +${100 + gameState.bonuses.onTime} points`);
            updateOrdersDisplay();
        }
        
        function updateShiftTimer() {
            gameState.shiftTime -= 1/60; // Decrement by 1 second per frame (60 fps)
            
            // Calculate efficiency
            const expectedOrders = gameState.shiftGoal * (1 - gameState.shiftTime / (8 * 60));
            gameState.efficiency = (gameState.ordersCompleted / expectedOrders) * 100;
            if (gameState.efficiency > 100) gameState.efficiency = 100;
        }
        
        function updateWarehouseObjects() {
            // Update visual elements based on game state
            // This would sync other players' positions, etc.
        }
        
        // ==================== UI FUNCTIONS ====================
        function updateGameUI() {
            // Update stats
            document.getElementById('ordersCompleted').textContent = gameState.ordersCompleted;
            document.getElementById('itemsPicked').textContent = gameState.itemsPicked;
            
            // Update time
            const minutes = Math.floor(gameState.shiftTime);
            const seconds = Math.floor((gameState.shiftTime % 1) * 60);
            document.getElementById('timeLeft').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress
            const progress = (gameState.ordersCompleted / gameState.shiftGoal) * 100;
            document.getElementById('shiftProgress').style.width = `${Math.min(progress, 100)}%`;
            document.getElementById('shiftGoal').textContent = gameState.shiftGoal;
            
            // Update efficiency bonus
            document.getElementById('efficiencyBonus').textContent = 
                `${Math.floor(gameState.efficiency)}%`;
        }
        
        function updateOrdersDisplay() {
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '';
            
            gameState.currentOrders.slice(0, 5).forEach(order => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                
                const pickedCount = order.items.filter(i => i.picked).length;
                const packedCount = order.items.filter(i => i.packed).length;
                const totalItems = order.items.length;
                
                orderItem.innerHTML = `
                    <div class="order-header">
                        <span>${order.id}</span>
                        <span style="color: ${order.priority === 'high' ? '#e76f51' : '#2a9d8f'}">
                            ${order.priority === 'high' ? 'üö® HIGH' : 'üì¶ Normal'}
                        </span>
                    </div>
                    <div>Status: <strong>${order.status.replace('_', ' ').toUpperCase()}</strong></div>
                    <div>Progress: ${pickedCount}/${packedCount}/${totalItems} items</div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <span class="order-tag" style="
                                background: ${item.packed ? '#2a9d8f' : item.picked ? '#e9c46a' : '#457b9d'};
                                color: ${item.packed || item.picked ? 'white' : '#a8dadc'};
                            ">
                                ${item.packed ? '‚úì' : item.picked ? '‚Üí' : '‚óã'} ${item.name}
                            </span>
                        `).join('')}
                    </div>
                `;
                
                ordersList.appendChild(orderItem);
            });
        }
        
        function selectRole(role) {
            gameState.playerRole = role;
            
            // Update player info
            if (gameState.players[gameState.playerId]) {
                gameState.players[gameState.playerId].role = role;
                gameState.players[gameState.playerId].name = 
                    role === 'picker' ? 'Picker' : 
                    role === 'packer' ? 'Packer' : 'Manager';
                
                // Update color based on role
                gameState.players[gameState.playerId].color = 
                    role === 'picker' ? '#2a9d8f' : 
                    role === 'packer' ? '#e9c46a' : '#e76f51';
            }
            
            // Update UI
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.role-card').classList.add('selected');
            
            network.updatePlayerList();
            showMessage(`Role selected: ${role}`);
        }
        
        function startShift() {
            gameState.shiftStarted = true;
            document.getElementById('waitingOverlay').classList.add('hidden');
            
            // Update status
            document.getElementById('statusMessage').className = 'status-message status-working';
            document.getElementById('statusMessage').innerHTML = 'üë∑ Shift Started! Work together to meet the goal!';
            
            // Hide role selection
            document.getElementById('roleSelection').classList.add('hidden');
            
            showMessage('Shift started! Goal: ' + gameState.shiftGoal + ' orders in 8 minutes.');
            
            // Sync game state
            network.syncGameState();
        }
        
        function endShift() {
            gameState.shiftStarted = false;
            
            const finalScore = gameState.score + 
                (gameState.ordersCompleted * 50) + 
                (gameState.efficiency * 10);
            
            const overlay = document.getElementById('waitingOverlay');
            overlay.classList.remove('hidden');
            overlay.innerHTML = `
                <h2>üìä Shift Complete!</h2>
                <p>Orders Completed: <strong>${gameState.ordersCompleted}/${gameState.shiftGoal}</strong></p>
                <p>Items Picked: <strong>${gameState.itemsPicked}</strong></p>
                <p>Items Packed: <strong>${gameState.itemsPacked}</strong></p>
                <p>Efficiency: <strong>${Math.floor(gameState.efficiency)}%</strong></p>
                <p style="font-size: 2rem; color: #e9c46a;">Final Score: ${finalScore}</p>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn" onclick="startNewShift()">üîÑ New Shift</button>
                    <button class="btn" onclick="resetToLobby()">üè† Back to Lobby</button>
                </div>
            `;
            
            showMessage(`Shift ended! Final score: ${finalScore}`);
        }
        
        function startNewShift() {
            // Reset shift stats but keep team
            gameState.shiftStarted = false;
            gameState.shiftTime = 8 * 60;
            gameState.ordersCompleted = 0;
            gameState.itemsPicked = 0;
            gameState.itemsPacked = 0;
            gameState.efficiency = 100;
            gameState.currentOrders = [];
            gameState.completedOrders = [];
            gameState.score = 0;
            gameState.bonuses = { onTime: 0, accuracy: 0, teamwork: 0 };
            
            // Generate new goal
            gameState.shiftGoal = 40 + Math.floor(Math.random() * 30);
            
            // Clear items and regenerate
            itemMeshes.forEach(item => scene.remove(item));
            itemMeshes = [];
            
            shelfMeshes.forEach(shelf => {
                shelf.items = [];
            });
            
            populateShelves();
            generateOrders(5);
            
            // Show waiting overlay
            document.getElementById('waitingOverlay').classList.add('hidden');
            
            // Update UI
            updateGameUI();
            updateOrdersDisplay();
            
            showMessage('New shift starting! Goal: ' + gameState.shiftGoal + ' orders');
            
            // Start after 3 seconds
            setTimeout(() => {
                startShift();
            }, 3000);
        }
        
        function resetToLobby() {
            gameState.shiftStarted = false;
            gameState.playerRole = null;
            
            // Reset player ready status
            if (gameState.players[gameState.playerId]) {
                gameState.players[gameState.playerId].ready = false;
                gameState.players[gameState.playerId].role = null;
            }
            
            // Show lobby UI
            document.getElementById('hostSection').classList.add('hidden');
            document.getElementById('joinSection').classList.remove('hidden');
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('waitingOverlay').classList.remove('hidden');
            document.getElementById('waitingOverlay').innerHTML = `
                <h2>üè≠ Warehouse Warriors</h2>
                <p>Create a room or join with a 4-digit code to start working!</p>
                <p style="font-size: 1.2rem; color: #e9c46a;">Choose your role: Picker, Packer, or Manager</p>
                <p style="font-size: 1rem; color: #a8dadc;">Real warehouse simulation with shift goals and team coordination</p>
            `;
            
            network.updatePlayerList();
            showMessage('Back to lobby. Create or join a new team!');
        }
        
        function showMessage(text) {
            const status = document.getElementById('statusMessage');
            status.textContent = text;
            status.className = 'status-message status-connected';
            setTimeout(() => {
                if (gameState.shiftStarted) {
                    status.className = 'status-message status-working';
                    status.innerHTML = 'üë∑ Working... ' + gameState.ordersCompleted + '/' + gameState.shiftGoal + ' orders';
                } else if (gameState.roomCode) {
                    status.innerHTML = `üè¢ Team ${gameState.roomCode} - Choose your role`;
                } else {
                    status.innerHTML = 'üîç Looking for available warehouse teams...';
                }
            }, 3000);
        }
        
        function showError(text) {
            const status = document.getElementById('statusMessage');
            status.textContent = text;
            status.className = 'status-message status-error';
            setTimeout(() => {
                status.className = 'status-message status-connecting';
                status.textContent = 'üîç Looking for available warehouse teams...';
            }, 3000);
        }
        
        // ==================== EVENT HANDLERS ====================
        function setupEventListeners() {
            // Keyboard events
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                keys[key] = true;
                
                // Prevent space from scrolling
                if (key === ' ') {
                    e.preventDefault();
                }
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });
            
            // Button events
            document.getElementById('createBtn').addEventListener('click', () => {
                const roomCode = network.createRoom();
                document.getElementById('roomCode').textContent = roomCode;
                document.getElementById('hostSection').classList.remove('hidden');
                document.getElementById('joinSection').classList.add('hidden');
                document.getElementById('roleSelection').classList.remove('hidden');
                document.getElementById('statusMessage').className = 'status-message status-connected';
                document.getElementById('statusMessage').innerHTML = `üè¢ Team ${roomCode} created!`;
                document.getElementById('waitingOverlay').classList.add('hidden');
                showMessage(`Team ${roomCode} created! Choose your role.`);
            });
            
            document.getElementById('joinBtn').addEventListener('click', () => {
                const roomCode = document.getElementById('roomInput').value.trim();
                if (network.joinRoom(roomCode)) {
                    document.getElementById('statusMessage').className = 'status-message status-connected';
                    document.getElementById('statusMessage').innerHTML = `üéØ Joining team ${roomCode}...`;
                    document.getElementById('waitingOverlay').classList.add('hidden');
                    document.getElementById('roleSelection').classList.remove('hidden');
                    showMessage(`Joining team ${roomCode}... Choose your role.`);
                }
            });
            
            document.getElementById('copyBtn').addEventListener('click', () => {
                const roomCode = document.getElementById('roomCode').textContent;
                navigator.clipboard.writeText(roomCode).then(() => {
                    showMessage(`‚úÖ Team code ${roomCode} copied!`);
                }).catch(() => {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = roomCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showMessage(`‚úÖ Team code ${roomCode} copied!`);
                });
            });
            
            document.getElementById('newCodeBtn').addEventListener('click', () => {
                const roomCode = network.generateRoomCode();
                gameState.roomCode = roomCode;
                network.currentRoom = roomCode;
                document.getElementById('roomCode').textContent = roomCode;
                showMessage(`üîÑ New team code: ${roomCode}`);
                network.syncGameState();
            });
            
            document.getElementById('readyBtn').addEventListener('click', () => {
                network.sendPlayerReady();
            });
            
            // Room input formatting
            const roomInput = document.getElementById('roomInput');
            roomInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
            });
            
            roomInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('joinBtn').click();
                }
            });
            
            // Window resize
            window.addEventListener('resize', () => {
                if (camera && canvas) {
                    camera.aspect = canvas.clientWidth / canvas.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                }
            });
        }
        
        // ==================== INITIALIZE ====================
        if (typeof THREE === 'undefined') {
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; color: white;">
                    <h2 style="color: #e76f51;">Error Loading Game</h2>
                    <p>Three.js failed to load. Please check your internet connection.</p>
                    <button onclick="location.reload()" style="
                        background: #2a9d8f; color: white; border: none; padding: 15px 30px;
                        border-radius: 10px; font-size: 1.1rem; cursor: pointer; margin-top: 20px;
                    ">üîÑ Refresh Page</button>
                </div>
            `;
        } else {
            window.addEventListener('load', initGame);
        }
    </script>
</body>
</html>
